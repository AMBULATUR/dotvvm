trigger:
- feature/azure-pipelines

pool:
  vmImage: ubuntu-latest

variables:
  DOTVVM_ROOT: $(Build.Repository.LocalPath)
  BUILD_CONFIGURATION: Release
  DISPLAY: :42
  DOTNET_NOLOGO: 1
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_CLI_TELEMETRY_OPTOUT: 1

jobs:
  - job: crossplatformBuild
    container: registry.gitlab.com/cafstep/dotvvm-test/dotvvm:latest
    steps:
      - script: npm ci --cache $(DOTVVM_ROOT)/.npm --prefer-offline
        workingDirectory: src/DotVVM.Framework
      - script: npm run build
        workingDirectory: src/DotVVM.Framework
      - script: dotnet restore --packages $(DOTVVM_ROOT)/.nuget src/Crossplatform.sln
      - script: dotnet build --no-restore --configuration $(BUILD_CONFIGURATION) src/Crossplatform.sln
      - publish: artifacts/
        name: crossplatformBuild

  - job: unitTestsCrossplatform
    container: registry.gitlab.com/cafstep/dotvvm-test/dotvvm:latest
    dependsOn: crossplatformBuild
    steps:
      - download: current
        artifact: crossplatformBuild
      - script: mv $(Pipeline.Workspace)/crossplatformBuild $(DOTVVM_ROOT)/artifacts
      - task: DotNetCoreCLI@2
        inputs:
          command: test
          projects: src/DotVVM.Framework.Tests.Common
          arguments: --no-build --configuration $(BUILD_CONFIGURATION)
          publishTestResults: true

  - job: uiTestsCrossplatform
    container: registry.gitlab.com/cafstep/dotvvm-test/dotvvm:latest
    dependsOn: crossplatformBuild
    steps:
      - download: current
        artifact: crossplatformBuild
      - script: mv $(Pipeline.Workspace)/crossplatformBuild $(DOTVVM_ROOT)/artifacts
      - script: Xvfb $DISPLAY -screen 0 800x600x16 &
      - script: |
          dotnet run --project $DOTVVM_ROOT/src/DotVVM.Samples.BasicSamples.AspNetCoreLatest \
            --no-build \
            --configuration Release \
            --urls http://localhost:16018/ &
      - task: DotNetCoreCLI@2
        inputs:
          command: test
          projects: src/DotVVM.Samples.Tests
          arguments: --no-build --configuration $(BUILD_CONFIGURATION)
          publishTestResults: true
