resources:
  repositories:
  - repository: dotvvm
    type: github
    endpoint: riganti
    name: riganti/dotvvm
    trigger:
    - main
  - repository: tests
    type: git
    name: cli-tests

trigger:
- main

pool:
  name: Default

variables:
  compilerPathFx: "dotvvm/src/DotVVM.Compiler/bin/Debug/net461/DotVVM.Compiler.exe"
  compilerPathCore: "dotvvm/src/DotVVM.Compiler/bin/Debug/netcoreapp3.1/DotVVM.Compiler.exe"

steps:
- checkout: dotvvm
- checkout: tests

## Compile DotVVM
- task: Npm@1
  displayName: "npm install"
  inputs:
    command: 'install'
    workingDir: 'dotvvm/src/DotVVM.Framework'

- task: Npm@1
  displayName: "npm run build"
  inputs:
    command: 'custom'
    workingDir: 'dotvvm/src/DotVVM.Framework'
    customCommand: 'run build'

- task: NuGetCommand@2
  displayName: "Restore packages in DotVVM"
  inputs:
    command: 'restore'
    restoreSolution: 'dotvvm/**/*.sln'
    feedsToUse: 'select'

- task: VSBuild@1
  displayName: "Build DotVVM"
  inputs:
    solution: 'dotvvm/**/*.sln'
    platform: 'Any CPU'
    configuration: 'Debug'

## Prepare test projects
- task: NuGetCommand@2
  displayName: "Restore packages in test projects"
  inputs:
    command: 'restore'
    restoreSolution: 'tests/**/*.sln'
    feedsToUse: 'select'

- task: VSBuild@1
  displayName: "Compile test projects"
  inputs:
    solution: 'tests/**/*.sln'
    platform: 'Any CPU'
    configuration: 'Debug'

## Run tests
- task: PowerShell@2
  displayName: "Empty App (.NET Framework 4.5.1)"
  inputs:
    targetType: 'inline'
    script: '"$(compilerPathFx)" "tests/owin/empty_net451/EmptyNet451/bin/Debug/EmptyNet451.dll" "tests/owin/empty_net451/EmptyNet451"'
    errorActionPreference: 'continue'
    failOnStderr: true
